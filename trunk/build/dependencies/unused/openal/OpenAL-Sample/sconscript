import SCons, os, glob, os.path

Import("env")
localenv = env.Copy()

# this is just a make wrapper in this case

def CleanFlagIsSet() :
	import SCons.Script.Main
	return SCons.Script.Main.options.clean

redirect = ""
if env['silent']:
	redirect = ">>/dev/null 2>&1"

if CleanFlagIsSet():
	print "\x1b[00;32mCleaning OpenAL ...\x1b[00m"
	sts = os.system("make clean " + redirect)
	if sts != 0:
		raise SCons.Errors.UserError, "Problem while cleaning OpenAL"
	print "\x1b[00;32m... OpenAL cleaned!\x1b[00m"
else:
	if not os.path.isfile(env.File("#/openal/OpenAL-Sample/src/.libs/libopenal.so.1.0.0").abspath) or env['forcerebuild']:
		if env['forcerebuild']:
			# clean first
			print "\x1b[00;32mcleaning OpenAL because of forced Rebuild!\x1b[00m"
			sts = os.system("make clean " + redirect)
			if sts != 0:
				raise SCons.Errors.UserError, "Problem while cleaning OpenAL"
		print "\x1b[00;32mConfiguring OpenAL ...\x1b[00m"
		sts = os.system("sh autogen.sh " + redirect)
		if sts != 0:
			raise SCons.Errors.UserError, "Problem while autogen"
		sts = os.system("sh configure " + redirect)
		if sts != 0:
			raise SCons.Errors.UserError, "Problem while configuring OpenAL"
		print "\x1b[00;32mBuilding OpenAL (non-parallel)...\x1b[00m"
		# parallel build crashes the openal build system!
		sts = os.system("make " + redirect)
		if sts != 0:
			raise SCons.Errors.UserError, "Problem while making OpenAL"
		print "\x1b[00;32m... OpenAL build and ready!\x1b[00m"
	else:
		print "\x1b[00;32mOpenAL already built!\x1b[00m"
